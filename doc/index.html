<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="KeyWords" content="closed captions, teletext, ivtv, mythtv, libzvbi">
   <title>cc2subtitles - Convert CCs to DVD subtitles</title>
</head>
<body>

<h1 align=center>
cc2subtitles
</h1>
<h2 align=center>
Convert Closed Captions to DVD Subtitles
</h2>
<hr>
<b>cc2subtitles</b> is a solution for the one feature I wanted that MythTV didn't
provide "out of the box."
Namely, the ability to burn recordings to DVDs with closed captions.
If you're reading this, you know that closed captions are lost when you use
the MythTV plugin, mytharchive, to burn DVDs recorded by MythTV.
<p>
Here are some details that should help you decide whether <b>cc2subtitles</b> might be useful to you:
<ul>
<li>
<b>cc2subtitles</b> is the project name.
It contains a number of tools used to burn DVDs with closed captions.
The project started with a single program called <b>cc2subtitles</b>,
which can extract closed captions from recordings made with the ivtv and cx18
drivers, converting them into a format that spumux (a dvdauthor tool)
can use to add the closed captions as subtitles to recordings.
Other tools have been added to this project over time.
<li>
The <b>cc2subtitles</b> program only
works with recordings made with MPEG-2 hardware encoders,
such as Hauppauge analog cards
supported by the ivtv and cx18 drivers.
Tested with NTSC recordings made with the ivtv and cx18 drivers using the analog
inputs of a Hauppauge PVR-150 and HVR-1600 connected to a US cable TV provider.
<li>
The latest addition to the project is <b>mythsubtitles</b>, which can extract
closed captions from a wider variety of media file formats.
It is known to work with the following:
<ul>
<li>
ATSC/QAM recordings made with hardware DVB encoders supported by the cx18 and cx88 drivers and probably other dvb drivers.
Tested with QAM recordings made with the cx18 and cx88 drivers using the digital inputs of a Hauppauge HVR-1600 and a pcHDTV HD-5500 connected to a US cable TV provider.
<li>
Recordings made with MPEG-2 hardware encoders supported by the ivtv and cx18 drivers.
Tested with NTSC recordings made with the ivtv and cx18 drivers using the analog inputs of a Hauppauge PVR-150 and HVR-1600 connected to a US cable TV provider.
<li>
MythTV's NuppelVideo recordings, file extension .nuv.
Tested with NTSC recordings made with the cx88 driver using the analog input of a pcHDTV HD-5500 connected to a US cable TV provider.
<li>
Individual titles ripped from DVDs, typical file extension .vob.
Tested with titles ripped from NTSC DVDs using MythTV's MythVideo plug-in and
the "Perfect" option.
</ul>
<b>mythsubtitles</b> is able to support these media formats because it borrows
a lot of code from MythTV and
uses the MythTV versions of the ffmpeg libraries.
You must install and compile the MythTV source in order to build <b>mythsubtitles</b>.
<li>
<b>cc2subtitles</b> does not depend on the MythTV source.
<li>
Both <b>cc2subtitles</b> and <b>mythsubtitles</b> use a library called
<a href="http://zapping.sourceforge.net/doc/libzvbi/">libzvbi</a>
(also known as <i>ZVBI - VBI Decoding Library</i>).
libzvbi is part of the <a href="http://zapping.sourceforge.net/">Zapping</a>
project, a TV viewer for the <a href="http://www.gnome.org/">Gnome</a> desktop.
libzvbi is available as a debian package in the debian and ubuntu repositories, and probably many other repositories, too.
<li>
libzvbi supports PAL/SECAM Teletext, probably better than NTSC CC,
so there's a chance my tools will be able to convert Teletext to subtitles, too.
I haven't tested it, but would be willing to,
if I can get a hold of some PAL recordings.
Or, perhaps someone else in PAL land would like to do the work?
<li>
Both <b>mythsubtitles</b> and <b>cc2subtitles</b> convert closed caption data
found in recordings into DVD subtitles.
They take advantage of the fact that libzvbi can produce .png (Portable Network Graphics)
renderings of CC/Teletext.
An included bash script then uses spumux (part of dvdauthor) to
convert the .png images into DVD subtitles.
I think the results are more appealing than other solutions
that use spumux to encode text based subtitles.
The results look like what you're used to seeing on your TV,
including support for italics and special characters used in Spanish & French,
as well as the musical note.
Plus, libzvbi supports closed caption colors.
<br>
<i>Note: some special characters may require a <a href="#libzvbi.patch">patch for libzvbi</a>,
if you are using a version older than libzvbi-0.2.27.
</i>
<li>
I'm pretty sure my tools won't work if you like to cut commercials out of your recordings.
That's because of the timestamp data I use to figure out where to add subtitles to recordings.
My personal preference is to burn DVDs of recordings with as little manual intervention as possible.
But I don't like to watch commericals, either.
Instead of taking the time to cut commercials using MythTV, I have patched
mytharchive's script, mythburn.py,
to add chapter marks at the commercial marks found by mythcommflag.
As a result, I can easily skip forward over commercials when I play my recordings on a DVD player.
If mythcommflag didn't get it quite right, I can rewind as needed.
<li>
This package includes a bash shell script, <b>myburn</b>, which puts all the pieces together to produce DVDs with closed captions converted to subtitles.
All that's required to burn a DVD is to edit a mytharchive job file,
mydata.xml, listing the recordings you want to burn,
load a blank DVD in your DVD burner, then run <b>myburn</b>.
</ul>
Here are some example screen snapshots:
<p>
<img src="images/NotDancing-sub.jpg" width=640 height=480 align=ABSCENTER>
<p>
The above snapshot demonstrates:
<ul>
<li>
that CC subtitles are positioned the same as CCs
would be on your screen, not simply fixed to the bottom of the screen.
<li>
that italics are supported. In this case, italics are used to indicate an off screen speaker.
</ul>
<p>
<img src="images/Spanish-sub.jpg" width=640 height=480 align=ABSCENTER>
<p>
The above snapshot demostrates that Spanish characters are supported.
<p>
<img src="images/Spanish-nopatch.jpg" width=640 height=480 align=ABSCENTER>
<p>
The above snapshot was produced with an unpatched libzvbi-0.2.25.
Some Spanish characters are rendered, but the upside down question mark is
rendered as a block.
<br>
<i>Note: this problem was fixed in libzvbi-0.2.27</i>
<p>
You may be wondering if the captions are clipped if you view a 4:3 recording
in 16:9 mode. 
They should not be clipped as long as you tell your DVD player to stretch the
image vertically, rather than just using your wide screen TV's aspect ratio
settings.
For example, I set my Panasonic wide screen TV to full screen (not zoom)
and use my Panasonic DVD player's Display menu to set "4:3 aspect" to Zoom.
With these settings, subtitles are not clipped.
<p>
If you are comfortable configuring, compiling and installing source packages,
here it is:
<p>
<table border=1 cellpadding=1 cellspacing=0>
<tr bgcolor="#ccccff">
<td>Release</td>
<td>Date</td>
<td>Approximate Size</td>
<td>Reason</td>
</tr>
<tr>
<td>
<a href="cc2subtitles-0.7.tar.gz">cc2subtitles-0.7.tar.gz
</a></td>
<td>
2010-05-27
</td>
<td>583 KiB</td>
<td>
<ul>
<li>
Upgraded to MythTV 0.22 and 0.23
</ul>
</td>
</tr>
<tr>
<td>
<a href="cc2subtitles-0.6.tar.gz">cc2subtitles-0.6.tar.gz
</a></td>
<td>
2009-06-24
</td>
<td>583 KiB</td>
<td>
<ul>
<li>
Added mythsubtitles, an alternative to cc2subtitles.
Mythsubtitles supports more media file formats than cc2subtitles,
but requires that MythTV source be installed and built.
<li>
Added stripivtv, a utility that strips the private data stream
containing VBI data from recordings captured by the ivtv and cx18
drivers.
<li>
Added mytranscode, a shell script that transcodes ATSC/QAM recordings
into NTSC DVD compatible format.
<li>
Fixed problems compiling on 64 bit platform and regression tested
on 32 bit platform.
</ul>
</td>
</tr>
</table>
<p>
The package contains or builds a few other files:
<dl>
<dt>
<a href="#myburn">src/myburn</a>
<dd>
A bash script that automates the process of burning DVDs with closed captions converted to subtitles.
<dt>
<a href="#mydata.xml">doc/mydata.xml</a>
<dd>
An example mytharchive job file.
<dt>
<a href="#mythburn.patch">patches/mythburn*.patch</a>
<dd>
My patch for mythburn.py,
the mytharchive script that does most of the work of burning DVDs.
There are different versions for mythtv-0.20.2 and 0.21.
<dt>
<a href="#tweakdvdxml.py">src/tweakdvdxml.py</a>
<dd>
A script that tweaks dvdauthor.xml to my taste.
<dt>
<a href="#libzvbi.patch">patches/libzvbi-0.2.25.patch</a>
<dd>
A patch for libzvbi to render all special characters.
This patch is not required for version 0.2.27 or later.
<dt>
<a href="#libzvbi.patch">patches/libzvbi-0.2.31.patch</a>
<dd>
A patch that fixes an occasional core dump.
<dt>
doc
<dd>
A copy of this documentation.
<dt>
doc/mytheme
<dd>
The mytharchive theme I use to burn DVDs.
<dt>
doc/ffmpeg_dvd_ntsc.xml
<dd>
The encoding profile I use to burn DVDs.
It containes a modification of the LP encoding profile to transcode
media files that need transcoding to a DVD compatible format.
The transcoded files will have a resolution of 720x480 and
about 4 hours worth of recordings will fit on a single sided DVD.
To use it instead of the profile provided by MythTV, you need to
install this file in $HOME/.mythtv/MythArchive/ffmpeg_dvd_ntsc.xml
<dt>
src/decodempeg
<dd>
A utility that decodes MPEG-PS streams, printing information found in packet headers.
<dt>
src/stripivtv
<dd>
A utility that that strips the private data stream
containing VBI data from recordings captured by the ivtv and cx18
drivers.
The output can be used to burn DVDs using a patched version of dvdauthor
without all the CPU intensive muxing and demuxing that's done by mythburn.py.
See
<a href="http://ivtvdriver.org/index.php/Howto:ivtv_for_dvdauthor">Howto: ivtv for dvdauthor</a> for more information.
<dt>
src/mytranscode
<dd>
A shell script that transcodes ATSC/QAM recordings into NTSC DVD compatible
format using mencoder.
I had no end of problems trying to do this with ffmpeg, which is what
mytharchive uses on recordings that are not DVD compatible.
Fortunately, I found an example that worked here:
<a href="http://www.mplayerhq.hu/DOCS/HTML/en/menc-feat-vcd-dvd.html">
11.8. Using MEncoder to create VCD/SVCD/DVD-compliant files
</a>.
When recordings are transcoded, closed caption data is lost, so mytranscode
saves the original file with a .orig file extension 
so it can be used to convert closed captions to subtitles at a later time.
The <b>myburn</b> script checks for these .orig files and scans them for
closed captions instead of the transcoded files.

</dl>

<hr>
<h2>
Installation instructions
</h2>
<dl>
<dt><b>Install libzvbi (without patch)</b>
<dd>
<p>
Before you can build the <b>cc2subtitles</b> or <b>mythsubtitles</b> programs,
you must either install binary libzvbi development packages
or install and build the source package with
<a href="#libzvbi.patch">patches/libzvbi*.patch</a>.
The necessary binary packages are available in both Debian and Ubuntu repositories,
and probably most other distributions.
On Debian and Ubuntu, use your favorite package
installation tool and install <b>libzvbi-dev</b>.
For example:
<pre>
# apt-get libzvbi-dev
</pre>
This should install the development header files as well as the runtime library.
<p>
<dt><b>Install libzvbi (with patch)</b>
<dd>
<p>
You don't have to use libzvbi*.patch. But you may want to. See
<a href="#libzvbi.patch">patches/libzvbi*.patch</a>
for information about the patches.
<p>
<i>
Note: These instructions are minimal and apply to Debian based distributions, only.
The web is full of more detailed information on how to build source packages,
not only for Debian based distributions (e.g. Ubuntu), but others, too.
</i>
<p>
<ol>
<li>
Install and compile the source package, <b>zvbi</b>:
<pre>
# apt-get build-dep zvbi
# apt-get --compile source zvbi
</pre>
<code>apt-get --compile</code> will first patch and configure the source
so that, when it is compiled,
the results will be the same as the binary package.
<p>
<li>
Patch the source.
<p>
If you are using a version older than libzvbi-0.2.27:
<pre>
# cd zvbi-0.2.25
# patch -p1 < <i>path-to-cc2subtitles</i>/patches/libzvbi-0.2.25.patch
# patch -p1 < <i>path-to-cc2subtitles</i>/patches/libzvbi-0.2.31.patch
</pre>
If you are using libzvbi-0.2.27 or later:
<pre>
# cd zvbi-0.2.31
# patch -p1 < <i>path-to-cc2subtitles</i>/patches/libzvbi-0.2.31.patch
</pre>
<li>
Recompile and install
<pre>
# make install
</pre>
</ol>
<p>
<dt><b>Install and compile MythTV source</b>
<dd>
<p>
If you want to extract closed captions from the widest variety of recordings
using <b>mythsubtitles</b>,
you will first need to install and compile MythTV.
If you don't, you will only be able to extract closed catptions from recordings made with the ivtv driver and the analog inputs supported by the cx18 driver
using <b>cc2subtitles</b>.
<p>
<i>
Note: These instructions are minimal and apply to Debian based distributions, only.
The web is full of more detailed information on how to build source packages,
not only for Debian based distributions (e.g. Ubuntu), but others, too.
</i>
<p>
<ol>
<li>
Install and compile the source package, <b>mythtv</b>:
<pre>
# apt-get source mythtv
# apt-get build-dep mythtv
# apt-get --compile source mythtv
</pre>
<code>apt-get --compile</code> will first patch and configure the source
so that, when it is compiled,
the results will be the same as the binary package.
<p>
You do not need to install the .deb packages produced by this command.
In fact, you can remove them.
You just need to remember where the package was compiled.
<p>
Note: If you have installed the Mythbuntu Repos package, you need to add an appropriate deb-src line to /etc/apt/sources.list.d/mythbuntu-repos.list.
Make a copy of the line similar to:
<pre>
deb http://us.autobuilds.mythbuntu.org/mythbuntu/trunk-0.22/ubuntu karmic main
</pre>
then change the word, deb, to deb-src on the copied line.
Here's my version before the change:
<pre>
deb http://ppa.launchpad.net/mythbuntu/repos/ubuntu karmic main
deb http://us.autobuilds.mythbuntu.org/mythbuntu/trunk-0.22/ubuntu karmic main
</pre>
and after the change:
<pre>
deb http://ppa.launchpad.net/mythbuntu/repos/ubuntu karmic main
deb http://us.autobuilds.mythbuntu.org/mythbuntu/trunk-0.22/ubuntu karmic main
deb-src http://us.autobuilds.mythbuntu.org/mythbuntu/trunk-0.22/ubuntu karmic main
</pre>

<p>
<li>
Create a symlink to the source:
<pre>
# ln -s <i>mythtv-source-directory</i> /usr/src/mythtv
</pre>
This step makes it easier to configure the cc2subtitles package, because
/usr/src/mythtv is where cc2subtitles expects to find the MythTV source.
You don't have to create the symlink, but if you don't, you will need to
use the --with-mythtv-src argument when you configure cc2subtitles.
</ol>
<p>
<dt>
<b>Install cc2subtitles</b>
<dd>
<p>
<ol>
<li>
Download and unpack cc2subtitles
<pre>
# wget http://www.hbuus.com/cc2subtitles/cc2subtitles-0.7.tar.gz
# tar xf cc2subtitles-0.7.tar.gz
</pre>
<li>
Configure cc2subtitles
<pre>
# cd cc2subtitles-0.7
# ./configure \
    --with-mytharchive-tmp=<i>path-to-mytharchive-temp-dir</i> \
    --with-mytharchive-dir=<i>path-to-mytharchive-install-dir</i> \
    --with-dev-dvd=<i>dvd-device</i>
</pre>
Most options configure the bash script, <b>myburn</b>,
to match your environment and preferences.
One notable exception is <code>--with-mythtv-src</code>, needed to build <b>mythsubtitles</b>.
Following are descriptions of configure options unique to the <b>cc2subtitles</b> package:
<p>
<dl>
<dt>
<code>
--with-mytharchive-tmp=<i>path-to-mytharchive-temp-dir</i>
</code>
<dd>
Set the value to your <code>Myth Archive Temp Directory</code>, one of the
<code>MythArchive Settings</code> found in mythfrontend:
<br>
<code>
Utilities/Setup -> Setup -> Media Settings -> Archive Files Settings
</code>
<p>
Not optional, there is no default value.
However, if no value is specified, configure treats it
as a warning, not a fatal error.
This makes it easier to install and use cc2subtitles
without having MythTV installed.
<p>
<dt>
<code>
--with-mytharchive-dir=<i>path-to-mytharchive-install-dir</i>
</code>
<dd>
Set the value to the directory where the mytharchive plugin is installed.
<p>
Optional,
the default value is: <code>/usr/share/mythtv/mytharchive</code>
If the directory doesn't exist, configure treats it
as a warning, not a fatal error.
This makes it easier to install and use cc2subtitles
without having MythTV installed.
<p>
<dt>
<code>
--with-dev-dvd=<i>dvd-device</i>
</code>
<dd>
Set the value to the name of your DVD device.
<p>
Optional,
the default value is: <code>/dev/dvd</code>
<p>
<dt>
<code>
--enable-use-fifos=[yes|no]
</code>
<dd>
Enable or disable the use of FIFOs by the myburn script.
<p>
If your <code>Myth Archive Temp Directory</code> is on a file system
with less than 3 times the size of a DVD available
(e.g. 3 * 4.7 = 14.1 GB for DVD-R),
you should enable FIFOs. 
Even with FIFOs enabled, the file system will need at least 2 times
the size of a DVD available
(e.g. 2 * 4.7 = 9.4 GB for DVD-R).
<p>
Optional, the default is to use FIFOs.
<p>
<dt>
<code>
--enable-create-iso=[yes|no]
</code>
<dd>
Enable or disable creation of an ISO image of the DVD.
<p>
Enabling this option will require an extra DVD's worth of available disk space
in your <code>Myth Archive Temp Directory</code>.
<p>
Optional, the default is NOT to create an ISO.
<p>
<dt>
<code>
--with-mythtv-src=<i>path-to-mythtv-source</i>
</code>
<dd>
Set the value to the directory where you have installed and compiled the mythtv source.
<p>
<p>
Optional, the default value is: <code>/usr/src/mythtv</code>
If the directory doesn't contain mythfrontend, it treats it as a warning and configures <b>myburn</b> to use <b>cc2subtitles</b>, not <b>mythsubtitles</b>.
<p>
</dl>
<li>
Build and install
<pre>
# make
# make install
</pre>
If you did not install and compile MythTV source, you should instead use these commands:
<pre>
# cd src
# make
# make install
</pre>
</ol>

<dt>
<b>Configure mytharchive</b>
<dd>
<p>
I recommend enabling the "Use FIFOs" option in MythArchive Settings.
MythArchive Settings are found in mythfrontend:
<p>
Utilities/Setup -> Setup -> Media Settings -> Archive Files Settings
<p>
"Use FIFOs" is the 6th option on Page 2.
<p>
If you don't do this, you will need an extra DVD's worth of available disk space
in your <code>Myth Archive Temp Directory</code>.
<p>
<dt>
<b>Patch mythburn.py</b>
<dd>
<p>
To apply the patch, execute one of the following commands.
<p>
<ul>
<li>
If you have the mythplugins source installed:
<pre>
# patch <b>-p1</b> -d <i>path-to-mythplugins-source</i> -b < patches/mythburn-<i>version</i>.patch
# cd <i>path-to-mythplugins-source</i>
# make install
</pre>
<li>
If you do not have the mythplugins source installed:
<pre>
# patch <b>-p3</b> -d <i>path-to-mytharchive-install-dir</i> -b < patches/mythburn-<i>version</i>.patch
</pre>
where <code><i>path-to-mytharchive-install-dir</i></code> is the same value
you used when you configured the cc2subtitles package.
</ul>
<p>
Note the different values for patch's <b>-p</b>, prefix strip, argument.
<p>
<i>
Note: it is not absolutely essential to apply this patch.
But if you don't, you will have problems if you alternate between
using myburn and mytharchive to burn DVDs.
See <a href="#mythburn.patch">patches/mythburn*.patch</a> for more information
and work arounds.
</i>
<p>

<dt>
<b>Burn a DVD</b>
<dd>
<p>
<ol>
<li>
Create or edit the job file,
<code><i>path-to-mytharchive-temp-dir</i>/config/mydata.xml</code>.
<br>
See
<a href="#mydata.xml">doc/mydata.xml</a>
for more information.
<p>
If you are not comfortable editing the file, you can use
the mytharchive plugin to create the file.
Just be aware that this will mean your computer will duplicate effort
on some time consuming tasks.
If you use the plugin,
be sure you disable the "Create ISO" and "Burn DVD" options.
<p>
<li>
Insert blank or rewritable media into your burner.
<p>
<li>
Execute myburn.
Since this is such a time consuming process,
I like to run it in the background, capturing the output to examine later.
I also like to use nohup since I ususally run it in an ssh login session.
Using nohup means I can logout and login later to check the results.
So, I use this command:
<pre>
$ nohup myburn &
</pre>
The output will be in the file, nohup.out, in the current directory.
I can check the progress with this command:
<pre>
$ grep myburn nohup.out
</pre>
Here's example output from a successful burn:
<pre>
2009-02-08 00:33:10 myburn[7308] begin
2009-02-08 00:33:30 myburn[7308] Executing mythburn
2009-02-08 01:15:06 myburn[7308] Executing tweakdvdxml.py
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/3: Checking 1008_20090206203000.mpg for CC/Teletext
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/2: Checking 1008_20090207020000.mpg for CC/Teletext
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/5: Checking 1004_20090206193000.mpg for CC/Teletext
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/4: Checking 1004_20090205193000.mpg for CC/Teletext
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/1: Checking 1008_20090130220000.mpg for CC/Teletext
2009-02-08 01:15:07 myburn[7308] /video/tmp/work/6: Checking 1067_20090207210000.mpg for CC/Teletext
2009-02-08 01:16:59 myburn[7308] /video/tmp/work/4: Adding subtitles
2009-02-08 01:17:13 myburn[7308] /video/tmp/work/5: Adding subtitles
2009-02-08 01:19:31 myburn[7308] /video/tmp/work/6: Adding subtitles
2009-02-08 01:26:33 myburn[7308] /video/tmp/work/3: Adding subtitles
2009-02-08 01:32:36 myburn[7308] /video/tmp/work/1: Adding subtitles
2009-02-08 01:33:29 myburn[7308] /video/tmp/work/2: Adding subtitles
2009-02-08 01:33:29 myburn[7308] Executing dvdauthor -x /video/tmp/work/dvdauthor.xml
2009-02-08 02:01:59 myburn[7308] /video/tmp/work/1: Finished CC/Teletext processing
2009-02-08 02:26:14 myburn[7308] /video/tmp/work/2: Finished CC/Teletext processing
2009-02-08 02:37:03 myburn[7308] /video/tmp/work/3: Finished CC/Teletext processing
2009-02-08 02:38:48 myburn[7308] /video/tmp/work/4: Finished CC/Teletext processing
2009-02-08 02:40:42 myburn[7308] /video/tmp/work/5: Finished CC/Teletext processing
2009-02-08 02:45:10 myburn[7308] /video/tmp/work/6: Finished CC/Teletext processing
2009-02-08 02:46:38 myburn[7308] Executing growisofs -dvd-video -V 'MyBurn' -use-the-force-luke -Z /dev/dvd1 /video/tmp/work/dvd
2009-02-08 03:01:16 myburn[7308] Success!
</pre>
As you can see, it took a long time, about 2.5 hours to burn a 4.4 GB DVD.
FWIW, I was watching recordings the whole time.
Plus, a recording was in progress, along with commerical flagging,
for the first 1/2 hour.
All this on a system with a 32 bit AMD Sempron 3100+ and 1 GB RAM.
<p>
FWIW, I now have a new system that can burn a 4 GB DVD in about 34 minutes.
The new system has a 64 bit AMD X2 4850e CPU and 4 GB RAM.
<p>
</dl>

<hr>
<h2>
More Details
</h2>

<h3>
<a name="cc2subtitles">
src/cc2subtitles
</h3>
This executable program reads a TV recording and renders NTSC closed captions (and possibly PAL/SECAM Teletext) as .png (Portable Network Graphics) image files.
<p>
If the recording contains VBI data encoded by the IVTV driver,
cc2subtitles will feed the data to the libzvbi library to render closed captions
as .png images.
For each image file, cc2subtitles adds a record to an XML file that
specifies a start and end time when the image should be displayed
during playback.
The default file name is spumux.xml.
spumux.xml can be read by spumux (part of dvdauthor), which converts
the images into DVD subtitles and embeds them in an MPEG2 file.
cc2subtitles also adds XML comment tags containing the closed caption text
in spumux.xml.
<p>
If no closed captions are found in the TV recording,
cc2subtitles will remove spumux.xml and exit with a non-zero code.
<h3>
<a name="mythsubtitles">
mythsubtitles/mythsubtitles
</h3>
This executable program adds support for a wider range of media formats as described at the top of this page.
It is a backward compatible replacement for the cc2subtitles program.
However, it also adds a dependency on the MythTV source.
<h3>
<a name="myburn">
src/myburn
</h3>
This bash script is a wrapper around mythsubtitles/cc2subtitles and
mythburn.py (part of the mytharchive plug-in), which does most of the work.
I prefer to use myburn from the command line rather than
mythfrontend/mytharchive,
because I find it easier to edit the job file from a ssh login than use the
mythfrontend GUI and
I can still watch recordings with mythfrontend while
this script is busy prepping files to burn to DVD.
<b>myburn</b> assumes you have set up a mytharchive job file,
<code><i>path-to-mytharchive-temp-dir</i>/config/mydata.xml</code>,
described below.
<p>
<b>myburn</b> automates the process of:
<ol>
<li>
transcoding, demuxing, and remuxing recordings and videos into a DVD compatible format.
<li>
creating DVD menus and an XML file
(dvdauthor.xml)
that tells dvdauthor how to assemble the desired DVD file system.
<li>
tweaking dvdauthor.xml to match my personal tastes, using tweakdvdxml.py
<li>
for each recording:
<ol type="a">
<li>
executing mythsubtitles or cc2subtitles to render closed captions as images and create spumux.xml.
<li>
executing spumux to convert the images into subtitles and embedding them into a new mpeg file.
</ol>
<li>
executing dvdauthor to create the DVD file system.
<li>
optionally executing mkisofs to convert the DVD file system into an ISO image.
<li>
executing growisofs to burn the DVD file system or ISO image onto DVD.
</ol>
The mytharchive script, mythburn.py, normally does all but steps 3 and 4.

<h3>
<a name="mydata.xml">
doc/mydata.xml
</h3>
An example mytharchive job file.
<p>
When you use mytharchive to burn DVDs, it creates the job file,
<code><i>path-to-mytharchive-temp-dir</i>/config/mydata.xml</code>.
The job file is the way mytharchive tells it's helper script, mythburn.py, what recordings and videos you want to burn to DVD.
The file also contains the choices you make on whether to create an ISO image
or to burn a DVD. Here's a copy of the example:
<pre>
&lt;!DOCTYPE mythburn>
&lt;mythburn>
    &lt;job theme="Compact" >
        &lt;media>

	    &lt;!-- The following line is for a recording made by mythtv-0.20.2 (Note the short file name) -->
            &lt;file usecutlist="0" type="recording" encodingprofile="NONE" filename="1007_20080217185500.mpg" />
	    &lt;!-- The following line is for a recording made by mythtv-0.21 (Note the full path name) -->
            &lt;file usecutlist="0" type="recording" encodingprofile="NONE" filename="/video/mythtv/recordings/1007_20080217185500.mpg" />

	    &lt;!-- The following line is for a DVD VOB imported by mythdvd (Note the full path name) -->
            &lt;file usecutlist="0" type="video" encodingprofile="NONE" filename="/video/mythtv/video/07-06-23-Swim.vob" />

        &lt;/media>

	&lt;!-- The following line defines option values, I added rundvdauthor="0" -->
        &lt;options rundvdauthor="0" dvdrsize="4482" mediatype="0" erasedvdrw="0" createiso="0" doburn="0" savefilename="" />
    &lt;/job>
&lt;/mythburn>
</pre>
<dl>
<dt>
<code>&lt;job></code> element
<dd>
<p>
This element's theme attribute specifies the look and feel you want for your DVD.
The available themes can be found here:
<code><i>path-to-mytharchive-install-dir</i>/themes</code>
where <code><i>path-to-mytharchive-install-dir</i></code> is the
directory where the mytharchive plugin is installed.
<p>
<dt>
<code>&lt;file></code> elements
<dd>
<p>
For each recording you select,
there will be a <code>&lt;file></code> element
with <code>type="recording"</code> indicating that the file is a recording.
In mythtv-0.20.2, the filename attribute is relative to the recording directory.
In mythtv-0.21, the filename attribute is the file's full path name.
In my case, the file, <code>1007_20080217185500.mpg</code> can be found in
<code>/video/mythtv/recordings</code> where <code>/video/mythtv</code> is
my storage directory and <code>recordings</code> is the subdirectory that
contains recordings made by MythTV.
I can usually figure out what recording I want by listing the contents of
the directory.
The file names are formatted as follows:
<code>TCCC_YYYYMMDDhhmmss.mpg</code>.
In this case:
<p>
<code>T</code> is 1 for tuner 1.
<br>
<code>CCC</code> is 007 for channel 7.
<br>
<code>YYYY</code> is 2008, the year.
<br>
<code>MM</code> is 02, the month.
<br>
<code>DD</code> is 17, the day of the month.
<br>
<code>hh</code> is 18, the hour based on 24 hour clock.
<br>
<code>mm</code> is 55, the minutes.
<br>
<code>ss</code> is 00, the seconds.
<p>
In other words, the recording was made on tuner 1, channel 7,
on February 17, 2008 starting at 18:55:00 (6:55 PM).
<p>
For each video you select,
there will be a <code>&lt;file></code> element
with <code>type="video"</code> indicating that the file is an imported video.
The filename attribute is the full path name of the imported video file.
You can see from this example that my storage directory is
<code>/video/mythtv</code> and imported videos are stored in the
<code>video</code> subdirectory.
<p>
The other attributes apply to both recordings and videos:
<dl>
<dt>
<code>usecutlist</code>
<dd>
must be set to 0, because cc2subtitles doesn't know about cut lists.
If you set usecutlist to 1, CC subtitles will not be in sync with your
video and audio.
<dt>
<code>encodingprofile</code>
<dd>
can be HQ (high quality, 1 hour/DVD), SP (standard play, 2 hours/DVD),
LP (long play, 4 hours/DVD) or EP (extended play, 6 hours/DVD),
or it can be NONE, if you don't want your recordings or videos re-encoded.
</dl>
<dt>
<p>
<code>&lt;option></code> element
<dd>
<p>
There should be only one <code>&lt;option></code> element.

<dl>
<dt> <code>rundvdauthor</code> <dd>
I added support for this option to mythburn.py.
If you use 
<a href="#mythburn.patch">patches/mythburn*.patch</a>,
setting this attribute to 0 will tell mythburn.py NOT to run dvdauthor.
This will save time because the myburn script will run dvdauthor after it adds
CC subtitles to the final DVD titles.

<dt> <code>dvdrsize</code> <dd>
This attribute specifies the capacity of the DVD media.
For single layer DVDs (including RW media), the value should be 4482.
For dual layer DVDs, the value should be 8964.

<dt> <code>mediatype</code> <dd>
This attribute specifies the media type.
<ol compact start=0>
<li>
single layer DVD
<li>
dual layer DVD
<li>
DVD +/- RW
<li>
file
</ol>

<dt> <code>erasedvdrw</code> <dd>
This attribute applies to DVD +/- RW media.
If you want growisofs to first erase the DVD, set this attribute to 1.
Otherwise, set it to 0.
The myburn script checks this attribute.
If it is non-zero, it calls growisofs with the option, -use-the-force-luke,
which improves the chances that growisofs will successfully burn
a rewritable DVD.

<dt> <code>createiso</code> <dd>
Must be set to 0 so mythburn.py doesn't waste time and disk space
creating the ISO that myburn will create later.

<dt> <code>doburn</code> <dd>
Must be set to 0 so mythburn.py does not try to burn the DVD that
myburn will burn later.

<dt> <code>savefilename</code> <dd>
As long as createiso is 0, this attribute has no effect.
Leave it as the null string.

</dl>

</dl>

<h3>
<a name="mythburn.patch">
patches/mythburn*.patch
</h3>
My patch for mythburn.py,
the mytharchive script that does most of the work of burning DVDs.
It patches the mythburn.py script that comes with mytharchive.
There are two patches:
<ul>
<li>
patches/mythburn-0.20.2.patch is for mythtv-0.20.2.
<li>
patches/mythburn-0.21.patch is for mythtv-0.21.
</ul>
I do not know if my latest patch will apply cleanly to an SVN version.
If you try it with SVN, please let me know whether the patch applies cleanly and
whether the script still works after patching.
<p>
I changed the script as follows:
<ol>
<li>
It adds support for an option to NOT run dvdauthor.
The option is specified in the mytharchive job file by adding the attribute:
<code>rundvdauthor="0"</code>
to the options element.
See 
<a href="#mydata.xml">doc/mydata.xml</a>
for an example.
Since dvdauthor has to be run after cc2subtitles and spumux,
telling mythburn.py to not run dvdauthor reduces the time it takes
to prepare and burn a DVD.
<li>
It creates chapter marks at transitions to/from commercials.
The original creates chapters at fixed 5 minute intervals.
<li>
It fixes a problem that prevents mytharchive from creating DVDs after
myburn has been used.
mythburn.py would terminate when it couldn't clean up working directories
left over from an earlier run of myburn.
That's because myburn creates subdirectories for cc2subtitles to store the
CC image files.
The fix was to change mythburn.py's deleteAllFilesInFolder function
to remove subdirectories as well as files.
<li>
Personally, I find the intro menu an annoying waste of time.
But when I tried my own theme with no intro,
my Panasonic DVD player would not play the menus at all.
So I found the cause and fixed it.
<li>
I changed how recording times are formatted on menus that display recording times.
Originally, mythburn.py used the start time of a program,
not the time when the recording started,
and it didn't display when the recording ended.
So you couldn't tell, looking at the menu, how long any title runs.
I changed it to display when a recording started and ended.
</ol>
If you do not patch mythburn.py, and want to switch between using mytharchive
and myburn, you may need to work around problem 3.
<ul>
<li>
If you don't intend to use myburn after mytharchive fills in the job file,
mydata.xml,
you will need to execute the following command before you use mytharchive:
<pre>
# rm -rf <i>path-to-mytharchive-temp-dir</i>/work
</pre>
where <code><i>path-to-mytharchive-temp-dir</i></code> is the same value
you used when you configured the cc2subtitles package.
<p>
<li>
If the reason you want to use mytharchive is to fill in the job file,
mydata.xml, and you still want to use myburn to add CC subtitles,
you just need to run myburn after mytharchive terminates.
Be sure you disable the "Create ISO" and "Burn DVD" options.
</ul>
<h3>
<a name="tweakdvdxml.py">
src/tweakdvdxml.py
</h3>
A script that tweaks dvdauthor.xml to my taste.
tweakdvdxml.py does some postprocessing on the dvdauthor.xml script
created by mythburn.py:
<ul>
<li>
It puts all the titles into one titleset.
<li>
It makes sure languages are specified for the audio and subtitle tracks.
If no language is specified by mythburn.py (and it isn't in 0.20.2),
tweakdvdxml.py will use the value of the LANG environment variable.
If LANG is unset, it sets the audio and subtitle languages to English.
There is also a command line option to override the default.
<li>
It tells a dvd player to play titles one after another,
instead of going back to the main menu after playing each title.
<li>
It moves the main menu from the root menu to the titleset menu.
That's because it's most convenient with my universal remote.
</ul>
I have only tested tweakdvdxml.py with dvdauthor.xml files created with
my own theme.
So the myburn script only executes it when the theme specified in mydata.xml is "mytheme".
So far, I have found one problem with tweakdvdxml.py.
If you burn a DVD with a mix of TV recordings from different video sources and/or imported videos,
it may seem as though there is no sound when you play back some titles.
It depends on whether all media files use the same audio format.
For example, those recorded by MPEG-2 hardware encoders will have MP2 audio,
while titles ripped from DVDs will have AC3 audio.
If they're different, you'll have to tell your DVD player to change
the audio track when playing titles that have a different audio format
than the first title.
If all media files have the same audio format, all should be well.
None of this will matter to you if you don't use "mytheme."
If you want to try "mytheme" and tweakdvdxml.py, you will have to copy this package's doc/mytheme directory to 
<code><i>path-to-mytharchive-install-dir</i>/themes/mytheme</code>.
<p>
If you decide to use "mytheme," here are some suggestions:
<ol>
<li>
Don't burn DVDs with a mix of TV recordings from different video sources and/or imported videos.
<p>
<li>
If you want to create a DVD with a mix of recordings and videos,
rerun dvdauthor with the untweaked dvdauthor_orig.xml, e.g.:
<pre>
dvdauthor -x <i>path-to-mytharchive-temp-dir</i>/work/dvdauthor_orig.xml
</pre>
<li>
Use a theme other than "mytheme" when burning a mix of recordings and videos.
</ol>

<h3>
<a name="libzvbi.patch">
patches/libzvbi-0.2.25.patch
</h3>
This patch addresses two issues with versions of libzvbi, prior to 0.2.27.
<ul>
<li>
It fixes a bug that causes some (but not all) special characters to be rendered as blocks.
In particular, the musical note and upside down question mark will be
rendered as blocks if you don't use this patch.
The bug is fixed in the CVS version.
When there is a new release available, my patch should not be needed.
<li>
It disables an annoying message that libzvbi writes to stderr.
Not a big deal, just annoying and time consuming.
</ul>
<h3>
patches/libzvbi-0.2.31.patch
</h3>
This patch fixes an occasional core dump caused by a bug in libzvbi.
The bug has been there since I started this project.
It was difficult to debug since valgrind and gdb watchpoints were no help.
I finally got serious about tracking it down when I upgraded to mythtv-0.21
and needed to make more changes to cc2subtitles.
For what it's worth, my patch has been accepted by the zvbi project,
so it shouldn't be needed with versions after 0.2.33.
<hr>
<h2>
Closing Remarks
</h2>
All feedback, questions and comments, are welcome.
For example:
<ul>
<li>
Comments on the documentation.
<br>
Is the level of detail too much, too little, or about right?
<br>
How about the way it's organized?
<li>
Comments on the package.
<br>
Can you use the package in its current form?
<br>
If not, why not?
<br>
Are you using a newer version of MythTV?
<br>
It doesn't have a pretty GUI and requires
some knowledge of MythTV to configure and use effectively.
Is that a show stopper?
<li>
Of course, if you like it, I welcome positive feedback.
</ul>
You can reach me at <u>mythtv at hbuus.com</u> (replace the "at" with @).
<p>
The latest version of this document can be found at:
<a href="http://www.hbuus.com/cc2subtitles/">http://www.hbuus.com/cc2subtitles/</a>

</body>
</html>
